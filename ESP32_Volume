#include <WiFi.h>
#include <WebServer.h>
#include <BleKeyboard.h> // Bluetooth Low Enery Library

// Replace with your desired network credentials
const char* ssid = "ESP32_Volume_Controller";
const char* password = "123456789";

WebServer server(80);

// Initialize BLE Keyboard
BleKeyboard bleKeyboard("ESP32_Volume", "ESP32", 100);

// HTML Web Page (same as before)
const char* htmlPage = R"rawliteral(
<!DOCTYPE HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { 
      font-family: Arial; 
      text-align: center; 
      margin: 0 auto; 
      padding-top: 30px; 
      background-color: #f0f0f0;
    }
    .btn {
      background-color: #4CAF50; /* Green */
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 8px;
      width: 200px;
    }
    .btn-mute { background-color: #f44336; } /* Red */
    .btn-vol { background-color: #008CBA; } /* Blue */
  </style>
</head>
<body>
  <h2>ESP32 Volume Control</h2>
  <p id="status">Connecting...</p>
  <p>
    <button class="btn btn-vol" onclick="volumeUp()">Volume Up</button>
  </p>
  <p>
    <button class="btn btn-vol" onclick="volumeDown()">Volume Down</button>
  </p>
  <p>
    <button class="btn btn-mute" onclick="volumeMute()">Mute</button>
  </p>
  <script>
    function updateStatus(connected) {
      document.getElementById('status').textContent = 
        connected ? 'Connected to PC' : 'Not connected to PC - Check Bluetooth';
      document.getElementById('status').style.color = connected ? 'green' : 'red';
    }
    
    function volumeUp() {
      fetch('/volumeup').then(r => console.log('Volume Up'));
    }
    function volumeDown() {
      fetch('/volumedown').then(r => console.log('Volume Down'));
    }
    function volumeMute() {
      fetch('/volumemute').then(r => console.log('Mute'));
    }
    
    // Check connection status periodically
    setInterval(() => {
      fetch('/status').then(r => r.text()).then(updateStatus);
    }, 2000);
  </script>
</body>
</html>
)rawliteral";

void handleRoot() {
  server.send(200, "text/html", htmlPage);
}

void handleVolumeUp() {
  if(bleKeyboard.isConnected()) {
    bleKeyboard.write(KEY_MEDIA_VOLUME_UP);
  }
  server.send(200, "text/plain", "Volume Up");
}

void handleVolumeDown() {
  if(bleKeyboard.isConnected()) {
    bleKeyboard.write(KEY_MEDIA_VOLUME_DOWN);
  }
  server.send(200, "text/plain", "Volume Down");
}

void handleVolumeMute() {
  if(bleKeyboard.isConnected()) {
    bleKeyboard.write(KEY_MEDIA_MUTE);
  }
  server.send(200, "text/plain", "Mute");
}

void handleStatus() {
  server.send(200, "text/plain", bleKeyboard.isConnected() ? "connected" : "disconnected");
}

void handleNotFound() {
  server.send(404, "text/plain", "Not Found");
}

void setup() {
  Serial.begin(115200);

  // Start BLE Keyboard
  bleKeyboard.begin();
  Serial.println("BLE Keyboard Started");

  // Create Access Point
  WiFi.softAP(ssid, password);
  IPAddress IP = WiFi.softAPIP();
  Serial.print("AP IP address: ");
  Serial.println(IP);

  // Define server routes
  server.on("/", handleRoot);
  server.on("/volumeup", handleVolumeUp);
  server.on("/volumedown", handleVolumeDown);
  server.on("/volumemute", handleVolumeMute);
  server.on("/status", handleStatus);
  server.onNotFound(handleNotFound);

  // Start server
  server.begin();
  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();
}
